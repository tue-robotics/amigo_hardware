########################################################################
#                                                                      #
# Controller TEST				 									   #
#                                                                      #
# Max Baeten                                                           #
# Mostly 2011                                                          #
#                                                                      #
########################################################################

#### Importing components ####
import("rtt_ros")
import("rtt_control_components")
import("soem_master")
import("soem_beckhoff_drivers")
import("tue_ethercat_drivers")
import("amigo_force_controller")


#### DECLARATION OF PARAMETERS ####
var double TS = 0.001
var double GEARRATIO 			= 8.0/343.0 ;## to do check param
var double TWOPI 				= 2.0*3.141592
var double ENCODERCOUNTS 		= 500.0*4.0
var double ENC2SI 				= TWOPI*GEARRATIO/ENCODERCOUNTS
var uint ENCBITS				= 65536
var uint N						= 8
var array UPPERJOINTLIMIT 		= array (	0.0,		1.57,		1.57, 		2.23,  		1.83, 		0.95,  		0.61,  		4.0		)
var array LOWERJOINTLIMIT 		= array (	-1.57,		-1.57,		-1.57,  	0.0, 		-1.83,		-0.95, 		-0.61, 		-4.0	)

#### DECLARATION OF COMPONENTS ####

### Interpolator ###
loadComponent("LPERA_ReferenceGenerator","SOURCES::ReferenceGenerator")
setActivity("LPERA_ReferenceGenerator",TS,HighestPriority,ORO_SCHED_RT)
LPERA_ReferenceGenerator.vector_size 		= N
LPERA_ReferenceGenerator.number_of_inports 	= 2
LPERA_ReferenceGenerator.inport_sizes 		= ints (7, 1)
LPERA_ReferenceGenerator.InterpolatorDt 	= TS
LPERA_ReferenceGenerator.InterpolatorEps 	= 1.0
LPERA_ReferenceGenerator.minPosition		= LOWERJOINTLIMIT
LPERA_ReferenceGenerator.maxPosition		= UPPERJOINTLIMIT
LPERA_ReferenceGenerator.maxVelocity		= array (0.4, 0.4, 0.6, 0.8, 0.8, 1.0, 1.0, 10.0)
LPERA_ReferenceGenerator.maxAcceleration	= array (0.2, 0.2, 0.3, 0.5, 0.5, 0.5, 0.5, 100.0)
LPERA_ReferenceGenerator.configure

### Constant Signal to provide runtime goals ###
loadComponent("Initial","SOURCES::ConstantSignal")
setActivity("Initial",0.001,HighestPriority,ORO_SCHED_RT)
Initial.vector_size		= 8
Initial.value 			= array(4.0, 0.0, 1.0, 0.0, -1.0, 8.0, 0.0, 0.5)
Initial.configure

### Constant Signal to provide runtime goals ###
loadComponent("Constant1","SOURCES::ConstantSignal")
setActivity("Constant1",10.0,HighestPriority,ORO_SCHED_RT)
Constant1.vector_size		= 7
Constant1.value 			= array(2.0, 0.0, 3.0, 0.0, -1.0, 0.0, 0.0)
Constant1.configure

### Constant Signal to provide runtime goals ###
loadComponent("Constant2","SOURCES::ConstantSignal")
setActivity("Constant2",10.0,HighestPriority,ORO_SCHED_RT)
Constant2.vector_size		= 1
Constant2.value 			= array(0.0)
Constant2.configure

#### DECLARATION OF CONECTIONS ####

connect ("Constant1.out","LPERA_ReferenceGenerator.posin1", ConnPolicy())
connect ("Constant2.out","LPERA_ReferenceGenerator.posin2", ConnPolicy())
connect ("Initial.out","LPERA_ReferenceGenerator.initial_pos", ConnPolicy())

### STARTING OF COMPONENTS ####
Initial.start()
LPERA_ReferenceGenerator.start()


